FROM node:24-slim

RUN apt-get update && apt-get install -y \
  openssl \
  ca-certificates \
  netcat-traditional \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /app

RUN npm install -g pnpm

COPY package.json pnpm-lock.yaml* ./
COPY pnpm-workspace.yaml* ./

RUN pnpm install

COPY prisma ./prisma/

RUN mkdir -p /app/uploads

EXPOSE 3000
EXPOSE 5555

ENV NODE_ENV=development
ENV PORT=3000

COPY <<EOF /app/start.sh
#!/bin/sh
set -e
echo "Generating Prisma Client..."
pnpm exec prisma generate
echo "Prisma Client generated successfully!"
echo "Starting development server..."
exec pnpm dev
EOF
RUN chmod +x /app/start.sh

CMD ["/app/start.sh"]
